
<!doctype html>
<html lang="en">
  <head>
    <title>
      StructureMap - Constructor Selection</title>
    
<meta charset="utf-8"/>
<meta name="description" content="FubuDocs"/>
<meta name="author" content="FubuDocs"/>




<link href="/_content/styles/sons-of-obsidian.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/toastr.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/twitter/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/twitter/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/toastr-responsive.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/fubudocs.core.css" rel="stylesheet" type="text/css" />
<link href="/_content/styles/fubudocs.theme.css" rel="stylesheet" type="text/css" />

<link media="screen" type="text/css" rel="stylesheet" href="http://fonts.googleapis.com/css?family=Oswald:400,300">

    
  </head>
  <body data-spy="scroll" data-target=".bs-docs-sidebar" position="relative">
      
    <div class="container">
      
      

<div class="row">
  <div class="span6">
    <p class="logo">
      <a href="/topics" title="Fubu" class="root-link"><span>Fubu</span></a>
      <a href="/" title="The original IoC/DI Container for .Net" class="project-logo"><span>StructureMap</span></a>
    </p>
  </div>
  <div class="span6">
    <div class="top-header text-right">
      <em>
        <em><a href="http://groups.google.com/group/structuremap-users?hl=en">Join our vibrant mailing list</a></em>
      </em>
      <div class="social">
        <a href="https://github.com/structuremap/structuremap" class="ico-github"><img alt="Github" src="/_content/images/github-icon.png" /></a>
      </div>
    </div>
  </div>
</div>
      

      <div id="nav-follow" class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <ul class="nav"><li><a href="/" data-key="index">StructureMap &#187;</a></li><li><a href="/registration" data-key="index">Registration &#187;</a></li><li class="active"><a href="/registration/constructor-selection" data-key="constructor-selection">Constructor Selection &#187;</a></li></ul>
<ul class="nav" style="float:right"><li><a href="/registration/on-missing-family-policies" title="On Missing Family Policies">Previous</a></li><li><a href="/registration/configuring-the-raw-model" title="Configuring the Raw Model">Next</a></li></ul>
          </div>
        </div>
      </div>
      <hr/>
      <div class="row">
        
        

        <div class="row">
          <div class="span3 sidebar" data-spy="affix" data-offset-top="150" data-offset-bottom="200">
            
            <h3 class="half-margin">Topics</h3>
            <ul id="page-toc" class="nav nav-tabs nav-stacked bs-docs-sidebar">
            </ul>
            <br/>
            <h3>
              StructureMap v1.0.0
            </h3>

            <br/>
            <h3 class="no-margin">Next</h3>
<p><a href="/registration/configuring-the-raw-model" data-key="configuring-the-raw-model">Configuring the Raw Model</a></p>
<h3 class="no-margin">Previous</h3>
<p><a href="/registration/on-missing-family-policies" data-key="on-missing-family-policies">On Missing Family Policies</a></p>
          </div>
          <div class="span9">

              <h1 class="no-margin">Constructor Selection</h1>
              <hr class="header-line topic-line"></hr>

            <!--Title: Constructor Selection-->
<!--Url: constructor-selection-->
<p>StructureMap 3.* greatly improves the control over the selection of constructor functions to build concrete types
by allowing users to override the constructor selection on specific <em>Instance's</em> and register custom rules for
selecting constructors to override the basic StructureMap behavior. </p>

<div class="alert alert-info"><i class="icon-info-sign"></i>In all cases, StructureMap can only use <b>public</b> constructor functions.</div>

<p><section><h4 id="greedy" class="section-header">Greediest Constructor</h4></p>

<p>If there are multiple public constructor functions on a concrete class, StructureMap's default behavior is to 
select the "greediest" constructor, i.e., the constructor function with the most parameters. In the case of two or more
constructor functions with the same number of parameters StructureMap will simply take the first constructor encountered
in that subset of constructors.</p>

<p>The default constructor selection is demonstrated below:</p>

<pre data-linenums="26" class="prettyprint lang-cs">
        public class GreaterThanRule : Rule
        {
            public string Attribute { get; set; }
            public int Value { get; set; }

            public GreaterThanRule()
            {
            }

            public GreaterThanRule(string attribute, int value)
            {
                Attribute = attribute;
                Value = value;
            }
        }

        [Test]
        public void using_the_greediest_ctor()
        {
            var container = new Container(_ =&gt; {
                _.ForConcreteType&lt;GreaterThanRule&gt;().Configure
                    .Ctor&lt;string&gt;(&quot;attribute&quot;).Is(&quot;foo&quot;)
                    .Ctor&lt;int&gt;(&quot;value&quot;).Is(42);
            });

            var rule = container.GetInstance&lt;GreaterThanRule&gt;();
            rule.Attribute.ShouldEqual(&quot;foo&quot;);
            rule.Value.ShouldEqual(42);
        }

</pre>

<p></section></p>

<p><section><h4 id="explicit" class="section-header">Explicitly Selecting a Constructor</h4></p>

<p>To override the constructor selection explicitly on a case by case basis, you
can use the <code>SelectConstructor(Expression)</code> method in the <a href="/registration/registry-dsl" data-key="registry-dsl">Registry DSL</a>
as shown below:</p>

<pre data-linenums="122" class="prettyprint lang-cs">
        public class Thingie
        {
            public Thingie(IWidget widget)
            {
                CorrectCtorWasUsed = true;
            }

            public bool CorrectCtorWasUsed { get; set; }

            public Thingie(IWidget widget, IService service)
            {
                Assert.Fail(&quot;I should not have been called&quot;);
            }
        }

        [Test]
        public void override_the_constructor_selection()
        {
            var container = new Container(_ =&gt; {
                _.For&lt;IWidget&gt;().Use&lt;AWidget&gt;();

                _.ForConcreteType&lt;Thingie&gt;().Configure

                    // StructureMap parses the expression passed
                    // into the method below to determine the 
                    // constructor
                    .SelectConstructor(() =&gt; new Thingie(null));
            });

            container.GetInstance&lt;Thingie&gt;()
                .CorrectCtorWasUsed
                .ShouldBeTrue();
        }
</pre>

<p></section></p>

<p><section><h4 id="attribute" class="section-header">[DefaultConstructor] Attribute</h4></p>

<p>Alternatively, you can override the choice of constructor function by using the 
older <code>[DefaultConstructor]</code> attribute like this:</p>

<pre data-linenums="88" class="prettyprint lang-cs">
        public class AttributedThing
        {
            // Normally the greediest ctor would be
            // selected, but using this attribute
            // will overrid that behavior
            [StructureMap.DefaultConstructor]
            public AttributedThing(IWidget widget)
            {
                CorrectCtorWasUsed = true;
            }

            public bool CorrectCtorWasUsed { get; set; }

            public AttributedThing(IWidget widget, IService service)
            {
                Assert.Fail(&quot;I should not have been called&quot;);
            }
        }

        [Test]
        public void use_a_custom_constructor_rule()
        {
            var container = new Container(_ =&gt; {
                _.For&lt;IWidget&gt;().Use&lt;AWidget&gt;();
            });

            container.GetInstance&lt;AttributedThing&gt;()
                .CorrectCtorWasUsed
                .ShouldBeTrue();

        }
</pre>

<p></section></p>

<p><section><h4 id="custom" class="section-header">Custom Constructor Selection Rule</h4></p>

<p>If the constructor selection logic isn't what you want, you can systematically 
override the selection rules by registering one or more custom <code>IConstructorSelector</code>
policies to a <code>Container</code>. Do note that you can register more than one policy and they
will be executed from last one registered to the first one registered. </p>

<p>Let's say that you want to control the constructor selection for all concrete 
subclasses of an abstract class like this hiearchy:</p>

<pre data-linenums="13" class="prettyprint lang-cs">
    public abstract class BaseThing
    {
        public BaseThing(IWidget widget)
        {
            CorrectCtorWasUsed = true;
        }

        public bool CorrectCtorWasUsed { get; set; }

        public BaseThing(IWidget widget, IService service)
        {
            Assert.Fail(&quot;I should not have been called&quot;);
        }
    }

    public class Thing1 : BaseThing
    {
        public Thing1(IWidget widget) : base(widget)
        {
        }

        public Thing1(IWidget widget, IService service) : base(widget, service)
        {
        }
    }

    public class Thing2 : BaseThing
    {
        public Thing2(IWidget widget) : base(widget)
        {
        }

        public Thing2(IWidget widget, IService service) : base(widget, service)
        {
        }
    }
</pre>

<p>You could create a custom <code>IConstructorSelector</code> like this one below to override
the constructor behavior for only subclasses of <code>BaseThing</code>:</p>

<pre data-linenums="52" class="prettyprint lang-cs">
    public class ThingCtorRule : IConstructorSelector
    {
        public ConstructorInfo Find(Type pluggedType)
        {
            // if this rule does not apply to the pluggedType,
            // just return null to denote &quot;not applicable&quot;
            if (!pluggedType.CanBeCastTo&lt;BaseThing&gt;()) return null;

            return pluggedType.GetConstructor(new Type[] {typeof (IWidget)});
        }
    }
</pre>

<p>Finally, you can register your custom rule as shown below:</p>

<pre data-linenums="69" class="prettyprint lang-cs">
        [Test]
        public void use_a_custom_constructor_selector()
        {
            var container = new Container(_ =&gt; {
                _.For&lt;IWidget&gt;().Use&lt;AWidget&gt;();

                _.Policies.ConstructorSelector&lt;ThingCtorRule&gt;();
            });

            container.GetInstance&lt;Thing1&gt;()
                .CorrectCtorWasUsed.ShouldBeTrue();

            container.GetInstance&lt;Thing2&gt;()
                    .CorrectCtorWasUsed.ShouldBeTrue();
        }
</pre>

<p></section></p>







          </div>
        </div>
      </div>
    </div>

    <br></br>
    <hr></hr>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <ul class="nav"><li><a href="/" data-key="index">StructureMap &#187;</a></li><li><a href="/registration" data-key="index">Registration &#187;</a></li><li class="active"><a href="/registration/constructor-selection" data-key="constructor-selection">Constructor Selection &#187;</a></li></ul>
<ul class="nav" style="float:right"><li><a href="/registration/on-missing-family-policies" title="On Missing Family Policies">Previous</a></li><li><a href="/registration/configuring-the-raw-model" title="Configuring the Raw Model">Next</a></li></ul>
        </div>
      </div>
    </div>
    
    
    

<script type="text/javascript" src="/_content/scripts/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="/_content/scripts/prettify.js"></script>
<script type="text/javascript" src="/_content/scripts/bootstrap-prettify.js"></script>
<script type="text/javascript" src="/_content/scripts/fubudocs.js"></script>
<script type="text/javascript" src="/_content/scripts/jquery.nestable.js"></script>
<script type="text/javascript" src="/_content/scripts/toastr.js"></script>
<script type="text/javascript" src="/_content/scripts/twitter/bootstrap.min.js"></script>
<script type="text/javascript" src="/_content/scripts/diagnostics/bootstrap-scrollspy.js"></script>
<script type="text/javascript" src="/_content/scripts/fubudocs-tools.js"></script>
<script type="text/javascript" src="/_content/scripts/twitter/bootstrap-affix.js"></script>
<script type="text/javascript" src="/_content/scripts/topics.js"></script>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
    </p>
    <p>
      Powered by <a href="http://github.com/DarthFubuMVC/FubuDocs">FubuDocs</a>.
    </p>
  </div>
</footer>
  </body>
</html>